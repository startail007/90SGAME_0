<!DOCTYPE html>
<html>

<head>
    <title>Untitled Document</title>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <script src="js/supplement.js"></script>
    <script src="js/pixi.min.js"></script>
    <script src="js/pixi-expansion.js"></script>
    <script src="js/matter.min.js"></script>
    <link href="css/style.css" rel="stylesheet">
    <script>
        var Engine=Matter.Engine,
            Render=Matter.Render,
            World=Matter.World,
            Bodies=Matter.Bodies,
            Events = Matter.Events,
            Body = Matter.Body;
            Composite = Matter.Composite,
            Bounds = Matter.Bounds,
            Common = Matter.Common; 

        window.onload = function(){

            var sw = Common.clamp(window.innerWidth,800,800);
            var sh = Common.clamp(window.innerHeight,600,600);
            var app = new PIXI.Application({
                width: sw,
                height: sh,
                backgroundColor: 0x000000,
                resolution: window.devicePixelRatio || 1,
            });
            document.body.appendChild(app.view);

            var game_stage = new PIXI.Container();
            app.stage.addChild(game_stage);
            var game_bgView = new PIXI.Container();
            game_stage.addChild(game_bgView);
            var game_view = new PIXI.Container();
            game_stage.addChild(game_view);

            app.loader.add('player', 'img/player.json');
            app.loader.add('bg01', 'img/bg01.png');
            app.loader.add('bg02', 'img/bg02.png');
            app.loader.add('floor02', 'img/floor02.png');
            app.loader.add('floor01', 'img/floor01.png');
            app.loader.on("progress", function(loader){
                //console.log(loader.progress,"loading"); 
            });            
            app.loader.load(function(loader, resources){
                //texture = resources.flowerTop.texture;
                init(loader, resources);
            });

            var engine=Engine.create(),
                world=engine.world;

            var render=Render.create({
                    engine:engine,
                    element:document.body,
                    options: {
                        width: sw,
                        height: sh
                    }
               });
            Engine.run(engine);
            Render.run(render);



            function init(loader, resources){
                //console.log(resources.aaa.textures)
                /*控制*/
                var control = {
                    left:keyboard(37),
                    right:keyboard(39),
                    spacebar:keyboard(32),
                    cameraUp:keyboard(87),
                    cameraDown:keyboard(83),
                }
                /*鏡頭*/
                var camera = {
                    x:0,
                    y:0
                }
                var cameraT = {
                    x:0,
                    y:600
                }
                /*圖層*/
                var bg_layer = new PIXI.Container();
                game_bgView.addChild(bg_layer);

                var floor_layer = new PIXI.Container();
                game_view.addChild(floor_layer);

                var container_layer = new PIXI.Container();
                game_view.addChild(container_layer);

                /*背景*/
                /*var bg01 = new PIXI.TilingSprite(resources.bg01.texture, app.screen.width, app.screen.height);                
                floor_layer.addChild(bg01);*/

                /*var bg02 = new PIXI.TilingSprite(resources.bg02.texture, app.screen.width*10, 1200);                
                floor_layer.addChild(bg02);
                var s = 1200/600;
                bg02.tileScale.x = bg02.tileScale.y = s;

                var bg01 = new PIXI.TilingSprite(resources.bg01.texture, app.screen.width*10, 1200);                
                floor_layer.addChild(bg01);
                var s = 1200/600;
                bg01.tileScale.x = bg01.tileScale.y = s;*/

                function createBox(texture, option){
                    option = Object.assign({
                        x: 0,
                        y: 0,
                        width: 50,
                        height: 50,
                        bound: undefined,
                        textureScale:0.5,
                        angle:0
                    },option);
                    //texture.wrapMode = PIXI.WRAP_MODES.REPEAT;
                    //var floor0001 = new PIXI.Sprite(texture);
                    var floor0001 = new PIXI.TilingSprite(
                        texture,
                        option.width,
                        option.height,
                    );
                    floor0001.tileScale.x = option.textureScale;
                    floor0001.tileScale.y = option.textureScale;
                    /*floor0001.tilePosition.x += 1;
                    floor0001.tilePosition.y += 1;*/
                    floor0001.position.x = option.width*0.5;                    
                    floor0001.position.y = option.height*0.5;
                    floor0001.anchor.set(0.5);
                    floor0001.createBody({
                        isStatic:true,
                        friction: 1,
                        frictionStatic:1,
                        restitution:0
                    },option.bound);
                    var tx = (option.bound?option.bound.left:0);
                    var ty = (option.bound?option.bound.top:0);
                    floor0001.translate(option.x - tx + floor0001.pivot.x,option.y - ty + floor0001.pivot.y);
                    floor0001.rotate(option.angle, {x:option.x,y:option.y});
                    return floor0001;
                }

                function createLenBox(texture, data, option){
                    option = Object.assign({
                        x:0,
                        y:0,
                        height: 50,
                        bound: undefined,
                        textureScale:0.5
                    },option);
                    var pp = data;
                    var floors = [];
                    for(var i=0;i<pp.length-1;i++){
                        var pp0 = pp[i];
                        var pp1 = pp[i+1];
                        var xx = pp1.x - pp0.x;
                        var yy = pp1.y - pp0.y;
                        var length = Math.sqrt(xx*xx+yy*yy);
                        var angle = Math.atan2(yy, xx);
                        var obj = Object.assign({},option);
                        obj = Object.assign(obj,{
                            x:option.x + pp0.x,
                            y:option.y + pp0.y,
                            width:length,
                            angle:angle
                        });
                        //console.log(pp0.x,option.y)
                        var floor_1 = createBox(texture,obj);
                        floors.push(floor_1);
                    }
                    return floors;
                }
                var floors = createLenBox(resources.floor02.texture,[
                    {x:0,y:0},
                    {x:100,y:-50},
                    {x:400,y:-50},
                    {x:600,y:50}
                ],{
                    x:0,
                    y:530,
                    height:100,
                    textureScale:100/66,
                    bound:{left:0,right:0,top:30,bottom:0}
                }).forEach(function(el){
                    floor_layer.addChild(el);
                    el.addBodyfrom(world).update();
                });

                var floors = createLenBox(resources.floor02.texture,[
                    {x:0,y:0},
                    {x:600,y:-100},
                    {x:1000,y:-100}
                ],{
                    x:600,
                    y:430,
                    height:100,
                    textureScale:100/66,
                    bound:{left:0,right:0,top:30,bottom:0}
                }).forEach(function(el){
                    floor_layer.addChild(el);
                    el.addBodyfrom(world).update();
                });

                var floors = createLenBox(resources.floor02.texture,[
                    {x:0,y:0},
                    {x:200,y:50},
                    {x:1000,y:50}
                ],{
                    x:1800,
                    y:300,
                    height:100,
                    textureScale:100/66,
                    bound:{left:0,right:0,top:30,bottom:0}
                }).forEach(function(el){
                    floor_layer.addChild(el);
                    el.addBodyfrom(world).update();
                });

                var floor_5 = createBox(resources.floor02.texture,{
                    x:0,
                    y:600-100+30,
                    width:9000,
                    height:100,
                    textureScale:100/66,
                    bound:{left:0,right:0,top:30,bottom:0}
                });
                floor_layer.addChild(floor_5);
                floor_5.addBodyfrom(world).update();

                var floor_6 = createBox(resources.floor01.texture,{
                    x:40,
                    y:320,
                    width:150,
                    height:50,
                    textureScale:0.5
                });
                floor_layer.addChild(floor_6);
                floor_6.addBodyfrom(world).update();


                var playerTextures = [];
                for (var temp in resources.player.textures) {
                    playerTextures.push(resources.player.textures[temp]);
                }    
                var character01 = new componentCharacter(playerTextures);
                container_layer.addChild(character01);
                character01.createBody({
                    head: 40*0.8,
                    bodyWidth: 60*0.8,
                    bodyHeight: 95*0.8,
                    footRadius: 15*0.8,
                    footDistance: 20*0.8
                });
                character01.addBodyfrom(world).translate(app.screen.width*0.5,600-100-400).update();
                character01.setControl(control);
                updateView();

                
                Events.on(engine, 'collisionEnd', function(event) {
                    var pairs = event.pairs;
                    for(var key in pairs){
                        var pair = pairs[key];                        
                        character01.onCollisionEnd(pair);                        
                    }
                });
                Events.on(engine, 'collisionStart', function(event) {
                    var pairs = event.pairs;
                    for(var key in pairs){
                        var pair = pairs[key];
                        character01.onCollisionStart(pair);                        
                    }
                });    

                var timestamp = engine.timing.timestamp;
                var a0 = 0;
                var a1 = 0;
                Events.on(engine, 'beforeUpdate', function(event) {
                    delta = event.timestamp - timestamp;
                    timestamp = event.timestamp;
                    a0+=delta/4000;
                    a0%=1;
                    a1+=delta/(90*1000);
                    a1%=1;

                    var easeInOutQuart =  function (x) {
                        return x < 0.5 ?
                            2 * x * x :
                            1 - Math.pow( -2 * x + 2, 2 ) / 2;
                    }
                    var temp = easeInOutQuart(1-Math.abs(a0-0.5)*2);

                    var x = 0 + (300-0)*temp;
                    var vx = x - floor_6.body.position.x;
                    floor_6.move(vx,0);

                    //cameraT.y=(1-a1)*(600-100);
                    /*var yy = 600-100;

                    var y = yy + (300-yy)*a1;
                    var vy = y - floor_5.body.position.y;
                    floor_5.move(0,vy);*/

                    character01.beforeUpdate(delta);
                    updateView(); 
                });

                Events.on(engine, 'afterUpdate', function(event) {
                });

                function updateView(){
                    if(control.cameraUp.isDown){
                        cameraT.y-=40;
                    }
                    if(control.cameraDown.isDown){                        
                        cameraT.y+=40;
                    }
                    camera.x = Common.clamp(character01.body.position.x,app.screen.width*0.5,9000 - app.screen.width*0.5);
                    camera.y = Common.clamp(character01.body.position.y,app.screen.height*0.5,600-app.screen.height*0.5);
                    //camera.y = Common.clamp(/*character01.body.position.y + */cameraT.y,app.screen.height*0.5,600-app.screen.height*0.5);
                    var xx = -camera.x + app.screen.width*0.5;
                    var yy = -camera.y + app.screen.height*0.5;
                    game_view.position.x = xx;
                    game_view.position.y = yy;
                    Render.lookAt(render, {
                        min:{
                            x:-xx,
                            y:-yy
                        },
                        max:{
                            x:-xx+app.screen.width,
                            y:-yy+app.screen.height
                        }
                    });
                }    
                //console.log(app.stage,app)
                app.ticker.add(function(delta){    
                    /*bg01.tilePosition.x = (camera.x - app.screen.width*0.5)*0.2;
                    bg02.tilePosition.x = (camera.x - app.screen.width*0.5)*0.4;*/
                    PIXI.bodyList.forEach(function(el){
                        el.update();
                    });
                });
                app.start();

                

            }
            
        }
        
    </script>
    <style>
        canvas{
            position: absolute;
            background: 0% 0% / contain rgb(15, 15, 19);
            left: 0px;
        }
        canvas:nth-child(2){            
            opacity: 0.25;
        }
    </style>
</head>

<body>
</body>

</html>
