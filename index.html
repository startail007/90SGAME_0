<!DOCTYPE html>
<html>

<head>
    <title>Untitled Document</title>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <script src="js/ease.js"></script>
    <script src="js/supplement.js"></script>
    <script src="js/pixi.min.js"></script>
    <script src="js/pixi-expansion.js"></script>
    <script src="js/matter.min.js"></script>
    <link href="css/style.css" rel="stylesheet">
    <script>
        var Engine=Matter.Engine,
            Render=Matter.Render,
            World=Matter.World,
            Bodies=Matter.Bodies,
            Events = Matter.Events,
            Body = Matter.Body;
            Composite = Matter.Composite,
            Bounds = Matter.Bounds,
            Common = Matter.Common; 

        window.onload = function(){

            var sw = Common.clamp(window.innerWidth,800,800);
            var sh = Common.clamp(window.innerHeight,600,600);
            var app = new PIXI.Application({
                width: sw,
                height: sh,
                backgroundColor: 0x000000,
                resolution: window.devicePixelRatio || 1,
            });
            document.body.appendChild(app.view);

            var game_stage = new PIXI.Container();
            app.stage.addChild(game_stage);
            var game_bgView = new PIXI.Container();
            game_stage.addChild(game_bgView);
            var game_view = new PIXI.Container();
            game_stage.addChild(game_view);

            app.loader.add('map', 'js/map.json');
            app.loader.add('circle01', 'img/circle01.png');
            app.loader.add('player', 'img/player.json');
            app.loader.add('bg01', 'img/bg01.png');
            app.loader.add('bg02', 'img/bg02.png');
            app.loader.add('floor02', 'img/floor02.png');
            app.loader.add('floor01', 'img/floor01.png');
            app.loader.on("progress", function(loader){
                //console.log(loader.progress,"loading"); 
            });            
            app.loader.load(function(loader, resources){
                //texture = resources.flowerTop.texture;
                init(loader, resources);
            });

            Engine.collision = {
                collisionStart:[],
                collisionEnd:[]
            };
            Engine.collision.addCollisionStart = function(body, trigger){
                this.collisionStart.push({
                    body:body,
                    trigger:trigger
                });
            }
            Engine.collision.addCollisionEnd = function(body, trigger){
                this.collisionEnd.push({
                    body:body,
                    trigger:trigger
                });
            }
            //console.log(Matter)
            var engine=Engine.create(),
                world=engine.world;

                //console.log(engine);

            var render=Render.create({
                    engine:engine,
                    element:document.body,
                    options: {
                        width: sw,
                        height: sh
                    }
               });
            Engine.run(engine);
            Render.run(render);



            function init(loader, resources){
                //console.log(resources.map)
                /*控制*/
                var control = {
                    left:keyboard(37),
                    right:keyboard(39),
                    spacebar:keyboard(32),
                    cameraUp:keyboard(87),
                    cameraDown:keyboard(83),
                }
                /*鏡頭*/
                var camera = {
                    x:0,
                    y:0
                }
                var cameraT = {
                    x:0,
                    y:600
                }
                /*圖層*/
                var bg_layer = new PIXI.Container();
                game_bgView.addChild(bg_layer);

                var floor_layer = new PIXI.Container();
                game_view.addChild(floor_layer);

                var prop_layer = new PIXI.Container();
                game_view.addChild(prop_layer);

                var container_layer = new PIXI.Container();
                game_view.addChild(container_layer);

                /*背景*/
                /*var bg01 = new PIXI.TilingSprite(resources.bg01.texture, app.screen.width, app.screen.height);                
                floor_layer.addChild(bg01);*/

                /*var bg02 = new PIXI.TilingSprite(resources.bg02.texture, app.screen.width*10, 1200);                
                floor_layer.addChild(bg02);
                var s = 1200/600;
                bg02.tileScale.x = bg02.tileScale.y = s;

                var bg01 = new PIXI.TilingSprite(resources.bg01.texture, app.screen.width*10, 1200);                
                floor_layer.addChild(bg01);
                var s = 1200/600;
                bg01.tileScale.x = bg01.tileScale.y = s;*/

                function createBox(texture, option){
                    option = Object.assign({
                        x: 0,
                        y: 0,
                        width: 50,
                        height: 50,
                        bound: undefined,
                        textureScale:0.5,
                        angle:0
                    },option);
                    //texture.wrapMode = PIXI.WRAP_MODES.REPEAT;
                    //var floor0001 = new PIXI.Sprite(texture);
                    var floor0001 = new PIXI.TilingSprite(
                        texture,
                        option.width,
                        option.height,
                    );
                    floor0001.tileScale.x = option.textureScale;
                    floor0001.tileScale.y = option.textureScale;
                    /*floor0001.tilePosition.x += 1;
                    floor0001.tilePosition.y += 1;*/
                    floor0001.position.x = option.width*0.5;                    
                    floor0001.position.y = option.height*0.5;
                    floor0001.anchor.set(0.5);
                    floor0001.createBody("rect",{
                        isStatic:true,
                        friction: 1,
                        frictionStatic:1,
                        restitution:0
                    },option.bound);
                    var tx = (option.bound?option.bound.left:0);
                    var ty = (option.bound?option.bound.top:0);
                    floor0001.translate(option.x - tx + floor0001.pivot.x,option.y - ty + floor0001.pivot.y);
                    floor0001.rotate(option.angle, {x:option.x,y:option.y});
                    return floor0001;
                }
                function createCircle(texture, option){
                    option = Object.assign({
                        x: 0,
                        y: 0,
                        radius: 50
                    },option);

                    var floor0001 = new PIXI.Sprite(texture);
                    floor0001.width = option.radius*2;
                    floor0001.height = option.radius*2;
                    floor0001.anchor.set(0.5);
                    floor0001.createBody("circle",{
                        isSensor:true,
                        isStatic:true
                    });
                    floor0001.translate(option.x,option.y);
                    return floor0001;
                }

                

                function createLenBox(texture, data, option){
                    option = Object.assign({
                        x:0,
                        y:0,
                        height: 50,
                        bound: undefined,
                        textureScale:0.5
                    },option);
                    var pp = data;
                    var floors = [];
                    var ttt = 0;
                    for(var i=0;i<pp.length-1;i++){
                        var pp0 = pp[i];
                        var pp1 = pp[i+1];
                        var xx = pp1.x - pp0.x;
                        var yy = pp1.y - pp0.y;
                        var length = Math.sqrt(xx*xx+yy*yy);
                        var angle = Math.atan2(yy, xx);
                        var obj = Object.assign({},option);
                        obj = Object.assign(obj,{
                            x:option.x + pp0.x,
                            y:option.y + pp0.y,
                            width:length,
                            angle:angle
                        });
                        //console.log(pp0.x,option.y)
                        var floor_1 = createBox(texture,obj);
                        floor_1.tilePosition.x = ttt;
                        ttt+=length;
                        floors.push(floor_1);

                        
                    }

                    for(var i=0;i<pp.length-1;i++){
                        var pp0 = pp[i];
                        var pp1 = pp[i+1];
                        for(var j=0;j<4;j++){
                            var circle0001 = createCircle(resources.circle01.texture,{
                                x:option.x + pp0.x+(pp1.x-pp0.x)*j/4,
                                y:option.y + pp0.y+(pp1.y-pp0.y)*j/4-30,
                                radius:15
                            });
                            res_layer.addChild(circle0001);
                            circle0001.addBodyfrom(world).update();
                        }
                    }
                    return floors;
                }
                /*var floors = createLenBox(resources.floor02.texture,[
                    {x:0,y:0},
                    {x:200,y:-50},
                    {x:400,y:-50},
                    {x:600,y:0}
                ],{
                    x:0,
                    y:530,
                    height:66,
                    textureScale:1,
                    bound:{left:0,right:0,top:20,bottom:0}
                }).forEach(function(el){
                    floor_layer.addChild(el);
                    el.addBodyfrom(world).update();
                });*/

                
                function createBox01(texture, option){
                    option = Object.assign({
                        x: 0,
                        y: 0,
                        width: 50,
                        height: 50,
                        bound: undefined,
                        textureScale:0.5,
                        angle:0
                    },option);
                    var item = new PIXI.TilingSprite(
                        texture,
                        option.width,
                        option.height,
                    );
                    item.tileScale.x = option.textureScale;
                    item.tileScale.y = option.textureScale;
                    item.anchor.set(0.5);
                    item.createBody("rect",{
                        isStatic:true,
                        friction: 1,
                        frictionStatic:1,
                        restitution:0,
                    },option.bound);
                    var tx = (option.bound?option.bound.left:0);
                    var ty = (option.bound?option.bound.top:0);
                    item.translate(option.x + item.pivot.x,option.y + item.pivot.y);
                    item.rotate(option.angle, {x:option.x,y:option.y});
                    return item;
                }

                function createCircle01(texture, option){
                    option = Object.assign({
                        x: 0,
                        y: 0,
                        radius: 50
                    },option);

                    var item = new PIXI.Sprite(texture);
                    item.width = option.radius*2;
                    item.height = option.radius*2;
                    item.anchor.set(0.5);
                    item.createBody("circle",{
                        data:{
                            el:item,
                            collision:function(){
                                item.visible = false;
                            }
                        },
                        isSensor:true,
                        isStatic:true,
                        collisionGroup:1
                    });
                    item.translate(option.x,option.y);
                    return item;
                }

                var map = resources.map.data;
                var flag = map.flag;
                var floors = map.floor;
                var props = map.prop;
                var moveFloor = map.moveFloor;
                for(var key in floors){
                    var itemData = floors[key];
                    var item = createBox01(resources.floor02.texture,{
                        x:itemData.x,
                        y:itemData.y,
                        width:itemData.width,
                        height:itemData.height,
                        angle:itemData.angle,
                        textureScale:1,
                        bound:{left:0,right:0,top:20,bottom:0}
                    });
                    floor_layer.addChild(item);
                    item.addBodyfrom(world).update();
                }
                for(var key in props){
                    var itemData = props[key];
                    var item = createCircle01(resources.circle01.texture,{
                        x:itemData.x,
                        y:itemData.y,
                        radius:itemData.width*0.5,
                        textureScale:1
                    });
                    prop_layer.addChild(item);
                    item.addBodyfrom(world).update();
                }
                for(var key in moveFloor){
                    var itemData = moveFloor[key];
                    createMoveFloor(itemData);
                }

                function createMoveFloor(itemData){
                    var item = createBox01(resources.floor01.texture,{
                        x:itemData.x,
                        y:itemData.y,
                        width:itemData.width,
                        height:itemData.height,
                        angle:itemData.angle,
                        textureScale:0.5
                    });
                    floor_layer.addChild(item);
                    item.addBodyfrom(world).update();
                    var xx = itemData.end.x - itemData.start.x;
                    var yy = itemData.end.y - itemData.start.y;
                    var len = Math.sqrt(xx*xx + yy*yy);
                    var duration = len*4000/300;
                    //console.log(duration);
                    item.addAnimation("move",duration,true,function(rate,data,src){
                        console.log('aaa');
                        var temp = EasingFunctions.easeInOutCubic(1-Math.abs(rate-0.5)*2);
                        var x = itemData.start.x + xx*temp;
                        var y = itemData.start.y + yy*temp;
                        var vx = x - src.body.position.x;
                        var vy = y - src.body.position.y;
                        src.move(vx,vy);
                    }).setTime(Math.random()*duration).play();
                    return item;
                }


                

                /*var floor_001 = createBox01(resources.floor01.texture,{
                    x:40,
                    y:480,
                    width:150,
                    height:50,
                    textureScale:0.5
                });
                floor_layer.addChild(floor_001);
                floor_001.addBodyfrom(world).update();
                floor_001.addAnimation("move",4000,true,function(delta,rate,data,src){
                    var temp = EasingFunctions.easeInOutQuart(1-Math.abs(rate-0.5)*2);
                    var x = 40 + (240-40)*temp;
                    var vx = x - src.body.position.x;
                    src.move(vx,0);
                }).play();

                var floor_002 = createBox01(resources.floor01.texture,{
                    x:600,
                    y:100,
                    width:150,
                    height:50,
                    textureScale:0.5
                });
                floor_layer.addChild(floor_002);
                floor_002.addBodyfrom(world).update();
                floor_002.addAnimation("move",8000,true,function(delta,rate,data,src){
                    var temp = EasingFunctions.easeInOutQuart(1-Math.abs(rate-0.5)*2);
                    var y = 100 + (540-100)*temp;
                    var vy = y - src.body.position.y;
                    src.move(0,vy);
                }).play();*/

                var floor_003 = createBox01(resources.floor01.texture,{
                    x:25,
                    y:300,
                    width:50,
                    height:600,
                    textureScale:0.5
                });
                floor_layer.addChild(floor_003);
                floor_003.addBodyfrom(world).update();


                var playerTextures = [];
                for (var temp in resources.player.textures) {
                    playerTextures.push(resources.player.textures[temp]);
                }    
                var character01 = new componentCharacter(playerTextures);
                container_layer.addChild(character01);
                var s = 0.6;
                character01.createBody({
                    head: 40*s,
                    bodyWidth: 60*s,
                    bodyHeight: 95*s,
                    footRadius: 15*s,
                    footDistance: 20*s
                });
                character01.addBodyfrom(world).translate(flag.x,flag.y).update();
                character01.setControl(control);
                
                updateView();

                Events.on(engine, 'collisionStart', function(event) {
                    var pairs = event.pairs;
                    for(var key in pairs){
                        var pair = pairs[key];
                        Engine.collision.collisionStart.forEach(function(el){
                            if(pair.bodyA.collisionGroup===pair.bodyB.collisionGroup){
                                if(pair.bodyA.id===el.body.id){
                                    el.trigger(pair.bodyB);
                                }else if(pair.bodyB.id===el.body.id){
                                    el.trigger(pair.bodyA);
                                }
                            }
                        });
                        //character01.onCollisionStart(pair);                        
                    }
                }); 
                Events.on(engine, 'collisionEnd', function(event) {
                    var pairs = event.pairs;
                    for(var key in pairs){
                        var pair = pairs[key];
                        Engine.collision.collisionEnd.forEach(function(el){
                            if(pair.bodyA.collisionGroup===pair.bodyB.collisionGroup){
                                if(pair.bodyA.id===el.body.id){
                                    el.trigger(pair.bodyB);
                                }else if(pair.bodyB.id===el.body.id){
                                    el.trigger(pair.bodyA);
                                }
                            }
                        });                                             
                        //character01.onCollisionEnd(pair);                        
                    }
                });
                   

                var timestamp = engine.timing.timestamp;
                var a1 = 0;
                Events.on(engine, 'beforeUpdate', function(event) {
                    delta = event.timestamp - timestamp;
                    timestamp = event.timestamp;
                    if(a1<1){                        
                        a1+=delta/(90*1000);
                        a1 = Math.min(a1,1);
                    }
                    //cameraT.x=app.screen.width*0.5 + a1*(14000-app.screen.width);                    
                    PIXI.beforeUpdateList.forEach(function(el){
                        el.beforeUpdate(delta);
                    });
                    updateView(); 
                });

                Events.on(engine, 'afterUpdate', function(event) {
                });

                function updateView(){
                    /*if(control.cameraUp.isDown){
                        cameraT.y-=40;
                    }
                    if(control.cameraDown.isDown){                        
                        cameraT.y+=40;
                    }*/
                    camera.x = Common.clamp(character01.body.position.x,app.screen.width*0.5,14000 - app.screen.width*0.5);
                    //camera.x = Common.clamp(cameraT.x,app.screen.width*0.5,14000 - app.screen.width*0.5);
                    camera.y = Common.clamp(character01.body.position.y,app.screen.height*0.5,600-app.screen.height*0.5);
                    //camera.y = Common.clamp(/*character01.body.position.y + */cameraT.y,app.screen.height*0.5,600-app.screen.height*0.5);
                    var xx = -camera.x + app.screen.width*0.5;
                    var yy = -camera.y + app.screen.height*0.5;
                    game_view.position.x = xx;
                    game_view.position.y = yy;
                    Render.lookAt(render, {
                        min:{
                            x:-xx,
                            y:-yy
                        },
                        max:{
                            x:-xx+app.screen.width,
                            y:-yy+app.screen.height
                        }
                    });
                }    
                //console.log(app.stage,app)
                app.ticker.add(function(delta){    
                    /*bg01.tilePosition.x = (camera.x - app.screen.width*0.5)*0.2;
                    bg02.tilePosition.x = (camera.x - app.screen.width*0.5)*0.4;*/
                    PIXI.updateList.forEach(function(el){
                        el.update();
                    });
                });
                app.start();

                

            }
            
        }
        
    </script>
    <style>
        canvas{
            position: absolute;
            background: 0% 0% / contain rgb(15, 15, 19);
            left: 0px;
        }
        canvas:nth-child(2){            
            opacity: 0.25;
        }
    </style>
</head>

<body>
</body>

</html>
