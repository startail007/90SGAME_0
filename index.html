<!DOCTYPE html>
<html>

<head>
    <title>Untitled Document</title>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <script src="js/ease.js"></script>
    <script src="js/supplement.js"></script>
    <script src="js/pixi.min.js"></script>
    <script src="js/pixi-expansion.js"></script>
    <script src="js/pixi-particles.js"></script>
    <script src="js/matter.min.js"></script>
    <script src="js/matter-expansion.js"></script>
    <link href="css/style.css" rel="stylesheet">
    <script>
        var Engine=Matter.Engine,
            Render=Matter.Render,
            World=Matter.World,
            Bodies=Matter.Bodies,
            Events = Matter.Events,
            Body = Matter.Body;
            Composite = Matter.Composite,
            Bounds = Matter.Bounds,
            Common = Matter.Common,
            Runner = Matter.Runner,
            Detector = Matter.Detector;

        window.onload = function(){
            var currentlyState = "";
            var sw = Common.clamp(window.innerWidth,800,800);
            var sh = Common.clamp(window.innerHeight,600,600);
            var app = new PIXI.Application({
                width: sw,
                height: sh,
                backgroundColor: 0x000000,
                resolution: window.devicePixelRatio || 1,
            });
            document.body.appendChild(app.view);

             
            var game_load = new PIXI.Container();
            app.stage.addChild(game_load);
            game_load.visible = false;

            var game_start = new PIXI.Container();
            app.stage.addChild(game_start);
            game_start.visible = false; 
            
            var game_stage = new PIXI.Container();
            app.stage.addChild(game_stage);
            game_stage.visible = false;

            var pages = {
                load:game_load,
                start:game_start,
                stage:game_stage,
            }

            Engine.collision = {
                collisionStart:[],
                collisionEnd:[]
            };
            Engine.collision.addCollisionStart = function(body, trigger){
                this.collisionStart.push({
                    body:body,
                    trigger:trigger
                });
            }
            Engine.collision.addCollisionEnd = function(body, trigger){
                this.collisionEnd.push({
                    body:body,
                    trigger:trigger
                });
            }

            var engine=Engine.create(),
                world=engine.world;

            /*var render=Render.create({
                    engine:engine,
                    element:document.body,
                    options: {
                        width: sw,
                        height: sh
                    }
               });*/
            //var runner = Engine.run(engine);
            var runner = Runner.create();
            
            //console.log(runner);

            /*Runner.run(runner);
            Runner.run(engine);*/
            //Engine.update(engine, 1000/30);

            //Render.run(render);

            /*控制*/
            var control = {
                left:keyboard(37),
                right:keyboard(39),
                spacebar:keyboard(32),
                /*cameraUp:keyboard(87),
                cameraDown:keyboard(83),
                reset:keyboard(90),*/
            }


            var pageStateMachine = new stateMachine();
            pageStateMachine.addState('',{
                trigger:function(){                    
                    this.setState('load');
                },
                input:function(){
                    currentlyState = pageStateMachine.getAllCurrentlyState();
                }
            });

            

            

            function changePage(pages, from, to){
                //console.log(from,to)
                if(from!==to){ 
                    if(pages[from]){
                        pages[from].visible = false;
                    }
                    if(pages[to]){
                        pages[to].visible = true;
                    }
                }
            }


            /*遊戲開始畫面*/
            initLoad();  


            /*資源載入*/
            var loaded = false;
            app.loader.add('emitter01', 'js/emitter01.json');
            app.loader.add('emitter02', 'js/emitter02.json');
            app.loader.add('map', 'js/map.json');
            app.loader.add('circle01', 'img/circle01.png');
            app.loader.add('player', 'img/player.json');
            app.loader.add('character01', 'img/character01.json');
            app.loader.add('bg01', 'img/bg01.png');
            app.loader.add('bg02', 'img/bg02.png');
            app.loader.add('bg03', 'img/bg03.png');
            app.loader.add('bg04', 'img/bg04.png');
            app.loader.add('bg05', 'img/bg05.png');
            app.loader.add('bg06', 'img/bg06.png');
            app.loader.add('floor02', 'img/floor02.png');
            app.loader.add('floor01', 'img/floor01.png');
            app.loader.add('wall01', 'img/wall01.png');
            app.loader.add('house01', 'img/house01.png');
            app.loader.add('gameStart', 'img/gameStart.png');
            app.loader.add('lose01', 'img/lose01.png');
            app.loader.add('lose02', 'img/lose02.png');
            app.loader.add('win', 'img/win.png');
            app.loader.on("progress", function(loader){
                //console.log(loader.progress,"loading"); 
            });            
            app.loader.load(function(loader, resources){
                //texture = resources.flowerTop.texture;
                if(!loaded){
                    loaded = true;
                    //pageChange("start");
                    //pageChange("stage");
                    init(loader, resources);
                }
            });
            app.start();
            initLoad();
            app.ticker.add(function(delta){
                pageStateMachine.stateTrigger();
            });


            function init(loader, resources){
                /*遊戲開始畫面*/
                initStart(loader, resources);                

                /*遊戲場景相關*/  
                initStage(loader, resources);
            }

            function initLoad(){
                var progress = 0;
                pageStateMachine.addState('load',{
                    trigger:function(){
                        //console.log(app.loader.progress)
                        if(app.loader.progress>=100&&Math.ceil(progress)>=100){
                            this.setState('start');
                        }
                        progress+=(app.loader.progress-progress)*0.1;
                        loadingText.text = 'loading '+Math.ceil(progress)+'%';
                    },
                    input:function(from, to){                                           
                        changePage(pages,from.id,to.id);
                        currentlyState = pageStateMachine.getAllCurrentlyState();
                    },
                    nav:['start']
                });
                /*文字*/
                var loadingText = new PIXI.Text('', {
                    fontFamily: 'Arial',
                    fontSize: '30px',
                    fontWeight: 'bold',
                    fill: '#FFFFFF',
                    align: 'center',
                    /*stroke: '#cc00ff',*/
                    strokeThickness: 1
                });
                loadingText.anchor.set(0.5,0.5);
                loadingText.position.set(app.screen.width*0.5, app.screen.height*0.5);
                game_load.addChild(loadingText);

            }
            function initStart(loader, resources){
                pageStateMachine.addState('start',{
                    trigger:function(){   
                        
                    },
                    input:function(from, to){                                                        
                        changePage(pages,from.id,to.id);
                        currentlyState = pageStateMachine.getAllCurrentlyState();
                    },
                    nav:['stage']
                });

                
                /*圖層*/
                var gameStartUI = new PIXI.Sprite(resources.gameStart.texture);
                game_start.addChild(gameStartUI);

                control.spacebar.release.push(function(){
                    if(currentlyState==="start"){
                        pageStateMachine.setState('stage');
                    }
                });
            }

            function initStage(loader, resources){

                var resetList = [];

                function createRect(texture, option){
                    option = Object.assign({
                        x: 0,
                        y: 0,
                        width: 50,
                        height: 50,
                        bound: undefined,
                        textureScale:0.5,
                        angle:0
                    },option);
                    var item = new PIXI.TilingSprite(
                        texture,
                        option.width,
                        option.height,
                    );
                    item.tileScale.x = option.textureScale;
                    item.tileScale.y = option.textureScale;
                    item.tilePosition.x = Math.random()*texture.orig.width;
                    item.anchor.set(0.5);
                    item.createBody("rect",{
                        isStatic:true,
                        friction: 0.3,
                        frictionStatic:0.9,
                        restitution:0,
                    },option.bound);
                    var tx = (option.bound?option.bound.left:0);
                    var ty = (option.bound?option.bound.top:0);
                    item.translate(option.x + item.pivot.x,option.y + item.pivot.y);
                    item.rotate(option.angle, {x:option.x,y:option.y});
                    return item;
                }

                function createCircle(texture, option, emitter){
                    option = Object.assign({
                        x: 0,
                        y: 0,
                        radius: 50
                    },option);
                    var visible = true;
                    var item = new PIXI.Sprite(texture);
                    item.width = option.radius*2;
                    item.height = option.radius*2;
                    item.anchor.set(0.5);
                    item.createBody("circle",{
                        data:{
                            el:item,
                            collision:function(){
                                if(visible){
                                    visible = false;
                                    item.setVisible(false);
                                    //console.log(item.position)
                                    emitter.ownerPos.set(item.position.x,item.position.y);
                                    emitter.emit = true; 
                                    /*item.removeBodyfrom(world);
                                    item.parent.removeChild(item);*/
                                    score+=Math.round(option.radius*option.radius);
                                }                                
                            }
                        },
                        isSensor:true,
                        isStatic:true,
                        collisionGroup:1
                    });
                    item.visibleFun = function(bool){
                        return visible&&bool;
                    }
                    item.translate(option.x,option.y);
                    resetList.push({
                        src:item,
                        trigger:function(){
                            if(!visible){
                                visible = true;
                                item.setVisible(true);
                            }
                        }
                    });
                    return item;
                }

                function createMoveFloor(texture, itemData){
                    var item = createRect(texture,{
                        x:itemData.x,
                        y:itemData.y,
                        width:itemData.width,
                        height:66,
                        angle:itemData.angle,
                        textureScale:1,
                        bound:{left:0,right:0,top:20,bottom:0}
                    });
                    var xx = itemData.end.x - itemData.start.x;
                    var yy = itemData.end.y - itemData.start.y;
                    var len = Math.sqrt(xx*xx + yy*yy);
                    var duration = len*4000/240;
                    var time = Math.random()*duration;
                    var animation = item.addAnimation("move",duration,true,function(src,rate,data){
                        var temp = EasingFunctions.easeInOutCubic(1-Math.abs(rate-0.5)*2);
                        var x = itemData.start.x + xx*temp;
                        var y = itemData.start.y + yy*temp;
                        var vx = x - src.body.position.x;
                        var vy = y - src.body.position.y;
                        src.move(vx,vy);
                    });
                    animation.setTime(time);
                    resetList.push({
                        src:item,
                        trigger:function(){
                            animation.setTime(time);
                        }
                    });
                    return item;
                }

                /*鏡頭*/
                var camera = {
                    x:0,
                    y:0
                }
                var cameraT = {
                    x:0,
                    y:600
                }

                pageStateMachine.addState('stage',{
                    trigger:function(){   
                        
                    },
                    input:function(from, to){
                        changePage(pages,from.id,to.id);
                        to.stateMachine.setState('start');
                        currentlyState = pageStateMachine.getAllCurrentlyState();
                    },
                    output:function(){                    
                        Runner.stop(runner);
                    },
                    nav:['start']
                });

                var pageStateMachine_game = pageStateMachine.activeSubStateMachine('stage');

                pageStateMachine_game.addState('start',{
                    trigger:function(){   
                    },
                    input:function(from, to){
                        changePage(uiPages,from?from.id:"",to.id);
                        Runner.stop(runner);
                        currentlyState = pageStateMachine.getAllCurrentlyState();                    
                    },
                    nav:['run']
                });
                pageStateMachine_game.addState('run',{
                    trigger:function(){ 
                    },
                    input:function(from, to){
                        changePage(uiPages,from?from.id:"",to.id);
                        Runner.stop(runner);
                        runner = Runner.run(engine);
                        currentlyState = pageStateMachine.getAllCurrentlyState();                    
                    },
                    nav:['win','lose01','lose02']
                });
                pageStateMachine_game.addState('win',{
                    trigger:function(){  
                        //player.controlJump = true;
                        //console.log(player.controlJump);
                    },
                    input:function(from, to){
                        changePage(uiPages,from?from.id:"",to.id);
                        //Runner.stop(runner);
                        //runner = Runner.run(engine);
                        currentlyState = pageStateMachine.getAllCurrentlyState();                    
                    },
                    nav:['start']
                });
                pageStateMachine_game.addState('lose01',{
                    trigger:function(){ 
                    },
                    input:function(from, to){
                        changePage(uiPages,from?from.id:"",to.id);
                        Runner.stop(runner);
                        currentlyState = pageStateMachine.getAllCurrentlyState();                    
                    },
                    nav:['start']
                });
                pageStateMachine_game.addState('lose02',{
                    trigger:function(){ 
                    },
                    input:function(from, to){
                        changePage(uiPages,from?from.id:"",to.id);
                        Runner.stop(runner);
                        currentlyState = pageStateMachine.getAllCurrentlyState();                    
                    },
                    nav:['start']
                });


                /*碰撞偵測*/
                Events.on(engine, 'collisionStart', function(event) {

                            
                    var pairs = event.pairs;
                    for(var key in pairs){
                        var pair = pairs[key];
                        //console.log(pair);
                        Engine.collision.collisionStart.forEach(function(el){
                            if(pair.bodyA.collisionGroup===pair.bodyB.collisionGroup){
                                if(pair.bodyA.id===el.body.id){
                                    el.trigger(pair.bodyB);
                                }else if(pair.bodyB.id===el.body.id){
                                    el.trigger(pair.bodyA);
                                }
                            }
                        });                   
                    }
                }); 
                Events.on(engine, 'collisionEnd', function(event) {

                            
                    var pairs = event.pairs;
                    for(var key in pairs){
                        var pair = pairs[key];
                        Engine.collision.collisionEnd.forEach(function(el){
                            if(pair.bodyA.collisionGroup===pair.bodyB.collisionGroup){
                                if(pair.bodyA.id===el.body.id){
                                    el.trigger(pair.bodyB);
                                }else if(pair.bodyB.id===el.body.id){
                                    el.trigger(pair.bodyA);
                                }
                            }
                        });                                                         
                    }
                });                
                /*測試*/
                /*control.reset.press.push(function(){
                    reset(loader, resources);
                });*/
                
                /*圖層*/

                var game_bgView = new PIXI.Container();
                game_stage.addChild(game_bgView);
                var game_view = new PIXI.Container();
                game_stage.addChild(game_view);
                var game_ui = new PIXI.Container();
                game_stage.addChild(game_ui);                
                /*var game_main_ui = new PIXI.Container();
                game_stage.addChild(game_main_ui);*/


                /*遊戲圖層*/
                var bg_layer = new PIXI.Container();
                game_bgView.addChild(bg_layer);

                var floor_layer = new PIXI.Container();
                game_view.addChild(floor_layer);

                var img_layer = new PIXI.Container();
                game_view.addChild(img_layer);

                var container_layer = new PIXI.Container();
                game_view.addChild(container_layer);

                var prop_layer = new PIXI.Container();
                game_view.addChild(prop_layer);

                var particles_layer = new PIXI.Container();
                game_view.addChild(particles_layer);


                /*開始遊戲圖層*/
                var ui_layer = new PIXI.Container();
                game_ui.addChild(ui_layer);
                ui_layer.visible = false;

                var start_layer = new PIXI.Container();
                game_ui.addChild(start_layer);
                start_layer.visible = false;

                var win_layer = new PIXI.Container();
                game_ui.addChild(win_layer);
                win_layer.visible = false;

                var lose01_layer = new PIXI.Container();
                game_ui.addChild(lose01_layer);
                lose01_layer.visible = false;

                var lose02_layer = new PIXI.Container();
                game_ui.addChild(lose02_layer);
                lose02_layer.visible = false;

                var lose01 = new PIXI.Sprite(resources.lose01.texture);
                lose01_layer.addChild(lose01);

                var lose02 = new PIXI.Sprite(resources.lose02.texture);
                lose02_layer.addChild(lose02);

                var win = new PIXI.Sprite(resources.win.texture);
                win_layer.addChild(win);

                

                var uiPages = {
                    run:ui_layer,
                    start:start_layer,
                    win:win_layer,
                    lose01:lose01_layer,
                    lose02:lose02_layer
                }

                var score = 0;
                /*文字*/
                var reciprocalTimeText = new PIXI.Text('', {
                    fontFamily: 'Arial',
                    fontSize: '60px',
                    fontWeight: 'bold',
                    fill: '#FFFFFF',
                    align: 'center',
                    stroke: '#000000',
                    strokeThickness: 10
                });
                reciprocalTimeText.anchor.set(0.5,0.5);
                reciprocalTimeText.position.set(app.screen.width*0.5, app.screen.height*0.5);
                start_layer.addChild(reciprocalTimeText);

                /*文字*/
                var timeText = new PIXI.Text('', {
                    fontFamily: 'Arial',
                    fontSize: '22px',
                    fontWeight: 'bold',
                    fill: '#FFFFFF',
                    align: 'center',
                    stroke: '#000000',
                    strokeThickness: 2
                });
                timeText.anchor.set(1,0);
                timeText.position.set(app.screen.width-10, 10);
                ui_layer.addChild(timeText);

                /*文字*/
                var scoreText = new PIXI.Text('', {
                    fontFamily: 'Arial',
                    fontSize: '22px',
                    fontWeight: 'bold',
                    fill: '#FFFFFF',
                    align: 'center',
                    stroke: '#000000',
                    strokeThickness: 2
                });
                scoreText.anchor.set(1,0);
                scoreText.position.set(app.screen.width-100, 10);
                ui_layer.addChild(scoreText);

                /*文字*/
                var scoreText01 = new PIXI.Text('', {
                    fontFamily: 'Arial',
                    fontSize: '40px',
                    fontWeight: 'bold',
                    fill: '#FFFFFF',
                    align: 'center',
                    stroke: '#000000',
                    strokeThickness: 2
                });
                scoreText01.anchor.set(1,0);
                scoreText01.position.set(app.screen.width-10, 10);
                win_layer.addChild(scoreText01);

                /*背景*/ 
                var bg06 = new PIXI.TilingSprite(resources.bg06.texture, app.screen.width, app.screen.height);                
                bg_layer.addChild(bg06);            
                var bg05 = new PIXI.TilingSprite(resources.bg05.texture, app.screen.width, app.screen.height);                
                bg_layer.addChild(bg05);
                var bg04 = new PIXI.TilingSprite(resources.bg04.texture, app.screen.width, app.screen.height);                
                bg_layer.addChild(bg04);
                var bg03 = new PIXI.TilingSprite(resources.bg03.texture, app.screen.width, app.screen.height);                
                bg_layer.addChild(bg03);
                var bg02 = new PIXI.TilingSprite(resources.bg02.texture, app.screen.width, app.screen.height);                
                bg_layer.addChild(bg02);
                var bg01 = new PIXI.TilingSprite(resources.bg01.texture, app.screen.width, app.screen.height);                
                bg_layer.addChild(bg01);

                /*粒子系統*/
                var emitter01 = new PIXI.particles.Emitter(
                    particles_layer,
                    [resources.circle01.texture],
                    resources.emitter01.data
                );
                emitter01.emit = false; 

                /*var emitter02 = new PIXI.particles.Emitter(
                    particles_layer,
                    [resources.circle01.texture],
                    resources.emitter02.data
                );*/

                /*場景產生*/
                var map = resources.map.data;
                var flag = map.flag;
                var floors = map.floor;
                var props = map.prop;
                var moveFloor = map.moveFloor;
                var walls = map.wall;
                var img = map.img;

                for(var key in walls){
                    var itemData = walls[key];
                    var item = createRect(resources.wall01.texture,{
                        x:itemData.x,
                        y:itemData.y,
                        width:itemData.width,
                        height:itemData.height,
                        angle:itemData.angle,
                        textureScale:1
                    });
                    floor_layer.addChild(item);
                    item.addBodyfrom(world).customUpdate();
                }
                for(var key in floors){
                    var itemData = floors[key];
                    var item = createRect(resources.floor02.texture,{
                        x:itemData.x,
                        y:itemData.y,
                        width:itemData.width,
                        height:itemData.height,
                        angle:itemData.angle,
                        textureScale:1,
                        bound:{left:0,right:0,top:20,bottom:0}
                    });
                    floor_layer.addChild(item);
                    item.addBodyfrom(world).customUpdate();
                }
                for(var key in props){
                    var itemData = props[key];
                    var item = createCircle(resources.circle01.texture,{
                        x:itemData.x,
                        y:itemData.y,
                        radius:itemData.width*0.5,
                        textureScale:1
                    },emitter01);
                    prop_layer.addChild(item);
                    item.addBodyfrom(world).customUpdate();
                }
                for(var key in moveFloor){
                    var itemData = moveFloor[key];
                    var item = createMoveFloor(resources.floor02.texture,itemData);
                    floor_layer.addChild(item);
                    item.addBodyfrom(world).customUpdate();
                    item.animationPlay("move");
                }

                for(var key in img){
                    var itemData = img[key];
                    if(resources[itemData.name]){
                        var item = new PIXI.Sprite(resources[itemData.name].texture);
                        item.width = itemData.width;
                        item.height = itemData.height;
                        item.anchor.set(0.5);
                        item.position.set(itemData.x,itemData.y);
                        img_layer.addChild(item);
                    }                    
                }

                //img_layer
                /*var floor_003 = createRect(resources.floor01.texture,{
                    x:25,
                    y:300,
                    width:50,
                    height:600,
                    textureScale:0.5
                });
                floor_layer.addChild(floor_003);
                floor_003.addBodyfrom(world).customUpdate();*/

                /*腳色產生*/
                var playerTextures = [];
                for (var temp in resources.player.textures) {
                    playerTextures.push(resources.player.textures[temp]);
                }    
                var player = new PIXI.componentCharacter(playerTextures);
                container_layer.addChild(player);
                var s = 0.6;
                player.createBody({
                    head: 40*s,
                    bodyWidth: 60*s,
                    bodyHeight: 95*s,
                    footRadius: 15*s,
                    footDistance: 20*s
                });
                player.addBodyfrom(world).translate(flag.x,flag.y).customUpdate();
                player.stateMachine.init();
                player.stateMachine.setState("base");

                /*阿偉腳色*/
                var character01Textures = [];
                for (var temp in resources.character01.textures) {
                    character01Textures.push(resources.character01.textures[temp]);
                } 
                var character01 = new PIXI.AnimatedSprite(character01Textures);
                img_layer.addChild(character01);
                //character01.position.set(11055,506);
                character01.animationSpeed = 0.6;
                character01.play();
                character01.createBody("rect",{
                    data:{
                        el:item,
                        collision:function(){
                            if(currentlyState==="stage.run"){
                                //console.log('完成啦');
                                pageStateMachine_game.setState("win");
                                player.init(engine);
                                scoreText01.text = "score:"+score;
                            }
                        }
                    },
                    isSensor:true,
                    isStatic:true,
                    collisionGroup:1
                });
                character01.body.position.x = 0;
                character01.body.position.y = 0;
                character01.body.positionPrev.x = 0;
                character01.body.positionPrev.y = 0;
                character01.pivot.set(0,-65);
                //console.log(character01.pivot);
                character01.addBodyfrom(world).translate(11055,506-65).customUpdate();



                /*腳色控制*/
                function addControl(key, fun){
                    key.press.push(function(){                
                        fun(true);
                    }); 
                    key.release.push(function(){              
                        fun(false);
                    });
                }

                addControl(control.left,function(bool){
                    if(currentlyState==="stage.run"||currentlyState==="stage.start"){
                        player.controlLeft = bool;
                    }
                });
                addControl(control.right,function(bool){
                    if(currentlyState==="stage.run"||currentlyState==="stage.start"){
                        player.controlRight = bool;
                    }
                });
                addControl(control.spacebar,function(bool){
                    if(currentlyState==="stage.run"||currentlyState==="stage.start"){
                        player.controlJump = bool;
                    }
                });

                control.spacebar.release.push(function(){
                    if(currentlyState==="stage.lose01"||currentlyState==="stage.lose02"){
                        reset(loader, resources);
                        pageStateMachine_game.setState("start");
                    }else if(currentlyState==="stage.win"){
                        reset(loader, resources);
                        pageStateMachine_game.setState("start");
                    }
                });



                

                /*外框牆壁*/
                var leftBox = Bodies.rectangle(0,0,40,app.screen.height+400,{
                    friction: 0,
                    frictionStatic: 0,
                    frictionAir: 0,
                    isStatic:true,
                    restitution:0,
                    collisionGroup:1,
                    data:{
                        el:null,
                        collision:function(){
                            //reset(loader, resources);
                            pageStateMachine_game.setState("lose01");
                        }
                    }
                },false);

                var rightBox = Bodies.rectangle(0,0,40,app.screen.height+400,{
                    friction: 0,
                    frictionStatic: 0,
                    frictionAir: 0,
                    isStatic:true,
                    restitution:0,                    
                },false);

                var bottomBox = Bodies.rectangle(0,0,app.screen.width+400,100,{
                    friction: 0,
                    frictionStatic: 0,
                    frictionAir: 0,
                    isSensor:true,
                    isStatic:true,
                    restitution:0,
                    collisionGroup:1,
                    data:{
                        el:null,
                        collision:function(){
                            //reset(loader, resources);
                            pageStateMachine_game.setState("lose02");
                        }
                    }
                },false);

                updateView();
                updateOutWall();
                World.add(world,leftBox);
                World.add(world,rightBox);
                World.add(world,bottomBox);

                function updateOutWall(){                    
                    Body.setPosition(leftBox, {x:camera.x-app.screen.width*0.5-20-140,y:app.screen.height*0.5});
                    Body.setPosition(rightBox, {x:camera.x+app.screen.width*0.5+20+10,y:app.screen.height*0.5});
                    Body.setPosition(bottomBox, {x:camera.x,y:camera.y+app.screen.height*0.5+200});
                }
                

                /*更新*/ 
                var timestamp = engine.timing.timestamp;
                var maxTime = 90;
                var time = 0;
                var reciprocalMaxTime = 3;
                var reciprocalTime = 0;
                timeText.text = Math.ceil(maxTime-time);
                Events.on(engine, 'beforeUpdate', function(event) {
                    delta = event.timestamp - timestamp;
                    timestamp = event.timestamp;               
                    if(currentlyState==="stage.run"||currentlyState==="stage.win"){
                        emitter01.update(delta*0.001); 
                        //emitter02.update(delta*0.001);                     
                        time+=delta*0.001;
                        if(time>=maxTime){
                            time = maxTime;
                        }
                        PIXI.customBeforeUpdateList.forEach(function(el){
                            el.customBeforeUpdate(delta);
                        });
                        var rate = Math.min(time/(maxTime),1);
                        cameraT.x=app.screen.width*0.5 + rate*(11300-app.screen.width);
                        updateView(); 
                        updateOutWall();
                    }                   
                });

                /*Events.on(engine, 'afterUpdate', function(event) {
                });*/

                function updateView(){                    
                    //cameraT.x = player.body.position.x;
                    camera.x = Common.clamp(cameraT.x,app.screen.width*0.5,11300 - app.screen.width*0.5);
                    camera.y = Common.clamp(player.body.position.y,app.screen.height*0.5,600-app.screen.height*0.5);

                    var xx = -camera.x + app.screen.width*0.5;
                    var yy = -camera.y + app.screen.height*0.5;
                    game_view.position.x = xx;
                    game_view.position.y = yy;
                    /*Render.lookAt(render, {
                        min:{
                            x:-xx,
                            y:-yy
                        },
                        max:{
                            x:-xx+app.screen.width,
                            y:-yy+app.screen.height
                        }
                    });*/
                }    
                //app.ticker.maxFPS = 30;
                var timestamp00 = engine.timing.timestamp;
                var ticker = app.ticker.add(function(delta){
                    if(currentlyState==="stage.run"||currentlyState==="stage.win"){
                        timeText.text = Math.ceil(maxTime-time);  
                        scoreText.text = "score:" + score;  
                        var xx = -(camera.x - app.screen.width*0.5);
                        bg01.tilePosition.x = (xx*0.75)%1200;
                        bg02.tilePosition.x = (xx*0.65)%1200;
                        bg03.tilePosition.x = (xx*0.55)%1200;
                        bg04.tilePosition.x = (xx*0.25)%1200;
                        bg05.tilePosition.x = (xx*0.2)%1200;
                        bg06.tilePosition.x = (xx*0.4)%1200;
                        PIXI.customUpdateList.forEach(function(el){
                            el.customUpdate();
                        });
                    }else if(currentlyState==="stage.start"){     
                        reciprocalTime+=ticker.elapsedMS*0.001;                   
                        reciprocalTimeText.text = Math.max(Math.ceil(reciprocalMaxTime-reciprocalTime),0);
                        if(reciprocalTime>=reciprocalMaxTime){
                            reciprocalTime = reciprocalMaxTime;
                            pageStateMachine_game.setState("run");
                        }
                    }
                });

                function reset(loader, resources){                    
                    score = 0;
                    reciprocalTime = 0;                    
                    time = 0;
                    emitter01.emit = false;
                    player.init(engine);
                    player.setPosition(flag.x,flag.y).customUpdate()
                    
                    resetList.forEach(function(el){
                        el.trigger();
                    }); 
                    var rate = Math.min(time/(maxTime),1);
                    cameraT.x=app.screen.width*0.5 + rate*(11300-app.screen.width);                    
                    PIXI.customBeforeUpdateList.forEach(function(el){
                        el.customBeforeUpdate(delta);
                    });
                    updateView(); 
                    updateOutWall();
                    timeText.text = Math.ceil(maxTime-time);
                    scoreText.text = "score:" + score;      
                    var xx = -(camera.x - app.screen.width*0.5);
                    bg01.tilePosition.x = (xx*0.95);
                    bg02.tilePosition.x = (xx*0.80);
                    bg03.tilePosition.x = (xx*0.65);
                    bg04.tilePosition.x = (xx*0.25);
                    bg05.tilePosition.x = (xx*0.2);
                    bg06.tilePosition.x = (xx*0.4);
                    PIXI.customUpdateList.forEach(function(el){
                        el.customUpdate();
                    });
                    reciprocalTimeText.text = Math.max(Math.ceil(reciprocalMaxTime-reciprocalTime),0);

                }
            }
            
        }
        
    </script>
    <style>
        canvas{
            position: absolute;
            background: 0% 0% / contain rgb(15, 15, 19);
            left: 0px;
        }
        canvas:nth-child(2){            
            opacity: 0.25;
        }
    </style>
</head>

<body>
</body>

</html>
